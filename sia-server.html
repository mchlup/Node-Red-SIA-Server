<script type="text/javascript">
    // ================================================
    // Registrace konfiguračního node "sia-server-config"
    // ================================================
    RED.nodes.registerType('sia-server-config', {
        category: 'config',
        defaults: {
            name:                  { value: "" },
            port:                  { value: 10000,    required: true },
            account:               { value: "",       required: false },
            receiverID:            { value: "",       required: false },
            allowedEvents:         { value: "",       required: false },
            zoneMap:               { value: "",       required: false },
            useAes:                { value: false,    required: false },
            aesKey:                { value: "",       required: false },
            reconnectInterval:     { value: 10,       required: false },
            allowedUsers:          { value: "",       required: false },
            language:              { value: "en",     required: false },
            crcMethod:             { value: "xmodem", required: false },
            ackTimeoutMs:          { value: 2000,     required: false },
            keepAliveIntervalMs:   { value: 60000,    required: false },
            autoRespondPolling:    { value: false,    required: false },
            pollResponseTemplate:  { value: "P#${account}", required: false },
            pushWebhookUrl:        { value: "",       required: false }
        },
        label: function() {
            return this.name || ("SIA Config " + this.port);
        }
    });

    // ================================================
    // Registrace hlavního node "sia-server"
    // ================================================
    RED.nodes.registerType('sia-server', {
        category: 'sia-server',
        color:    '#A6BBCF',
        defaults: {
            name:      { value: "" },
            config:    { type: "sia-server-config", required: true },
            debugMode: { value: true, required: false },
            rawOutput: { value: false, required: false }
        },
        inputs:  1,
        outputs: 2,
        icon:    "network.png",
        label: function() {
            return this.name || "SIA Server";
        }
    });
</script>

<!-- ================================================ -->
<!-- Konfigurační node – formulář (sia-server-config)  -->
<!-- ================================================ -->
<script type="text/x-red" data-template-name="sia-server-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Název konfigurace</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="icon-globe"></i> Port (TCP)</label>
        <input type="number" id="node-config-input-port" placeholder="10002">
    </div>
    <div class="form-row">
        <label for="node-config-input-account"><i class="icon-user"></i> Account ID (SIA ID – volitelné)</label>
        <input type="text" id="node-config-input-account" placeholder="000997">
    </div>
    <div class="form-row">
        <label for="node-config-input-receiverID"><i class="icon-id-badge"></i> Receiver ID (volitelné)</label>
        <input type="text" id="node-config-input-receiverID" placeholder="000997">
    </div>
    <div class="form-row">
        <label for="node-config-input-allowedEvents"><i class="icon-filter"></i> Povolené události (CSV)</label>
        <input type="text" id="node-config-input-allowedEvents" placeholder="BA,BF,GC,GP">
    </div>
    <div class="form-row">
        <label for="node-config-input-zoneMap"><i class="icon-map"></i> Mapování zón (JSON)</label>
        <textarea id="node-config-input-zoneMap" style="width: 100%;" rows="3" placeholder='{"01":"Vchod","02":"Garáž","03":"Kancelář"}'></textarea>
    </div>
    <div class="form-row">
        <label for="node-config-input-useAes"><i class="icon-lock-open"></i> Použít AES dešifrování</label>
        <input type="checkbox" id="node-config-input-useAes">
    </div>
    <div class="form-row">
        <label for="node-config-input-aesKey"><i class="icon-key"></i> AES klíč (hex 32 znaků)</label>
        <input type="text" id="node-config-input-aesKey" placeholder="0123456789ABCDEF0123456789ABCDEF">
    </div>
    <div class="form-row">
        <label for="node-config-input-reconnectInterval"><i class="icon-refresh"></i> Interval obnovení (s)</label>
        <input type="number" id="node-config-input-reconnectInterval" placeholder="10">
    </div>
    <div class="form-row">
        <label for="node-config-input-allowedUsers"><i class="icon-shield"></i> Povolení uživatelé (CSV)</label>
        <input type="text" id="node-config-input-allowedUsers" placeholder="0001,0002">
    </div>
    <div class="form-row">
        <label for="node-config-input-language"><i class="icon-globe"></i> Jazyk</label>
        <select id="node-config-input-language">
            <option value="en">English</option>
            <option value="cs">Čeština</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-config-input-crcMethod"><i class="icon-code"></i> CRC metoda</label>
        <select id="node-config-input-crcMethod">
            <option value="xmodem">CRC-16 XModem (výchozí)</option>
            <option value="x25">CRC-16 X.25</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-config-input-ackTimeoutMs"><i class="icon-time"></i> Timeout po ACK (ms)</label>
        <input type="number" id="node-config-input-ackTimeoutMs" placeholder="2000">
    </div>
    <div class="form-row">
        <label for="node-config-input-keepAliveIntervalMs"><i class="icon-lifebuoy"></i> Keep-alive interval (ms)</label>
        <input type="number" id="node-config-input-keepAliveIntervalMs" placeholder="60000">
    </div>
    <div class="form-row">
        <label for="node-config-input-autoRespondPolling"><i class="icon-repeat"></i> Automatická odpověď na polling</label>
        <input type="checkbox" id="node-config-input-autoRespondPolling">
    </div>
    <div class="form-row">
        <label for="node-config-input-pollResponseTemplate"><i class="icon-pencil"></i> Šablona odpovědi (např. P#${account})</label>
        <input type="text" id="node-config-input-pollResponseTemplate" placeholder="P#${account}">
    </div>
    <div class="form-row">
        <label for="node-config-input-pushWebhookUrl"><i class="icon-link"></i> Push Webhook URL (volitelné)</label>
        <input type="text" id="node-config-input-pushWebhookUrl" placeholder="https://example.com/webhook">
    </div>
</script>

<!-- ================================================ -->
<!-- Hlavní node – formulář (sia-server)               -->
<!-- ================================================ -->
<script type="text/x-red" data-template-name="sia-server">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Název uzlu</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="icon-cog"></i> Nastavení serveru</label>
        <input type="text" id="node-input-config">
    </div>
    <div class="form-row">
        <label for="node-input-debugMode"><i class="icon-bug"></i> Aktivovat DEBUG režim</label>
        <input type="checkbox" id="node-input-debugMode">
    </div>
    <div class="form-row">
        <label for="node-input-rawOutput"><i class="icon-eye"></i> Přeposílat RAW zprávy</label>
        <input type="checkbox" id="node-input-rawOutput">
    </div>
</script>

<!-- ================================================ -->
<!-- Nápověda pro konfigurační node                    -->
<!-- ================================================ -->
<script type="text/x-red" data-help-name="sia-server-config">
    <p>
      <b>SIA Server Config</b> – sdílená konfigurace:
      <ul>
        <li><b>Port:</b> TCP port, na kterém naslouchá ústředna (výchozí 10002).</li>
        <li><b>Account ID:</b> (volitelné) SIA-ID ústředny (např. „000997“). Pokud není zadáno, parser ho vezme z polling rámce.</li>
        <li><b>Receiver ID:</b> (volitelné) ID, které se vrací v ACK jako druhý parametr. Pokud není zadáno, použije se Account ID.</li>
        <li><b>Povolené události:</b> CSV event kódů (např. „BA,BF,GC“) – ostatní se ignorují.</li>
        <li><b>Mapování zón:</b> JSON objekt pro přeložení čísel zón (např. {"01":"Vchod"}).</li>
        <li><b>Použít AES:</b> Zaškrtněte, pokud ústředna posílá šifrované SIA rámce (AES-128-CBC).</li>
        <li><b>AES klíč:</b> Hexadecimální řetězec 16 bajtů (32 znaků), pokud je AES aktivní.</li>
        <li><b>Interval obnovení:</b> Počet sekund, po kterých se server pokusí restartovat naslouchání po chybě či odpojení.</li>
        <li><b>Povolení uživatelé:</b> CSV PIN kódů (např. „0001,0002“) – ARM/DISARM jen od těchto uživatelů.</li>
        <li><b>Jazyk:</b> Lokalizace textů („en“ / „cs“).</li>
        <li><b>CRC metoda:</b> Vyberte „xmodem“ (výchozí) nebo „x25“, podle manuálu ústředny.</li>
        <li><b>Timeout po ACK (ms):</b> Čas v ms (výchozí 2000), po kterém, pokud po ACK nepřijde platné SIA-DCS, server uzavře socket.</li>
        <li><b>Keep-alive interval (ms):</b> Čas v ms (výchozí 60000). Server posílá „F#<ReceiverID>“ pokud od ústředny nepřijde žádný paket.</li>
        <li><b>Automatická odpověď na polling:</b> Pokud je zaškrtnuto, po přijetí „F#…“ server odešle ACK podle šablony.</li>
        <li><b>Šablona odpovědi:</b> Např. <code>P#${account}</code>, podporuje <code>${account}</code> a <code>${zone}</code> (popř. <code>${suffix}</code>).</li>
        <li><b>Push Webhook URL:</b> (volitelné) Pošle JSON eventu na uvedenou URL (HTTP POST).</li>
      </ul>
    </p>
</script>

<!-- ================================================ -->
<!-- Nápověda pro hlavní node                          -->
<!-- ================================================ -->
<script type="text/x-red" data-help-name="sia-server">
    <p>
      <b>SIA Server</b> – uzel naslouchá TCP portu a zpracovává:
      <ul>
        <li><b>Polling (F# → P#):</b>  
            <ul>
              <li>Ústředna posílá <code>F#<Account><Suffix?></code>.</li>
              <li>Server při <code>autoRespondPolling</code> odešle <code>P#<Account>\r\n</code> (nebo podle šablony) a ústředna začne posílat SIA-DCS eventy.</li>
              <li>Pokud do <code>ackTimeoutMs</code> ms nepřijde validní SIA-DCS event, uzavře se socket a ústředna znovu pošle <code>F#…</code>.</li>
              <li>Server také každých <code>keepAliveIntervalMs</code> ms posílá <code>F#<ReceiverID>\r\n</code>, pokud nic od ústředny neobdržel, aby udržel spojení.</li>
            </ul>
        </li>
        <li><b>SIA-DCS (DC-09 Level 4):</b>  
            <ul>
              <li>Parsuje payload <code>[EVENT|ZONE:PART]Message</code>.</li>
              <li>Podpora volitelného <b>CRC-16</b> (XModem nebo X.25) – pokud extistuje na konci rámce, ověří se.</li>
              <li>Podpora <b>multi-fragmentace</b> – pokud řetězec končí „…“, akumuluje se do `pendingFragment` a čeká na další část.</li>
              <li>Podpora <b>extensions</b> (za základním payloadem oddělené „|“), např. <code>EXTENSION=BatteryLow|TIMESTAMP=20250607T134500</code>.</li>
              <li>Podpora <b>DIAG</b> – diagnostické pakety <code>[DIAG|…]…</code>.</li>
              <li>Podpora iBD eventů (např. <code>LANERR</code>, <code>NETDOWN</code>) – lze rozšířit o vlastní seznam diagnostických kódů.</li>
              <li>Po úspěšném parsování (a případné verifikaci CRC) se odešle <code>ACK <seq> <ReceiverID>\r\n</code> a event se pošle do prvního výstupu.</li>
            </ul>
        </li>
        <li><b>Contact-ID (ADM-CID):</b>  
            <ul>
              <li>Parsuje payload typu <code>event=… zone=… user=…</code> s ověřením CRC-16.</li>
              <li>Neodesílá ACK (Contact-ID používá vlastní protokol). Po validaci se event pošle do prvního výstupu.</li>
            </ul>
        </li>
        <li><b>Push-Webhook (volitelné):</b>  
            <ul>
              <li>Pokud je <code>pushWebhookUrl</code> zadán, pošle se každý validní event (SIA-DCS i Contact-ID) jako JSON do této URL metodou HTTP POST.</li>
            </ul>
        </li>
        <li><b>Role-based ARM/DISARM:</b>  
            <ul>
              <li>Pro příkazy <code>payload.action = "ARM"</code> nebo <code>"DISARM"</code> server kontroluje, zda <code>payload.code</code> je v <code>allowedUsers</code>. Jinak vrátí chybu.</li>
            </ul>
        </li>
        <li><b>Filtrace eventů:</b>  
            <ul>
              <li>Pokud je <code>allowedEvents</code> neprázdné, přijmou se pouze event kódy z toho seznamu.</li>
            </ul>
        </li>
        <li><b>Mapování zón:</b>  
            <ul>
              <li>Čísla zón se přeloží podle JSON <code>zoneMap</code>.</li>
            </ul>
        </li>
        <li><b>Logování:</b>  
            <ul>
              <li>Každá validní událost se zapíše do <code>/home/nodered/sia-events.log</code> ve formátu <code>ISO8601,Account,Event,Zone,Message,Extensions_JSON</code>.</li>
            </ul>
        </li>
        <li><b>Status v UI:</b>  
            <ul>
              <li>Zelená tečka = server naslouchá.</li>
              <li>Červený kroužek = odpojeno.</li>
              <li>Žlutý kroužek = chyba parsování nebo CRC (např. „SIA-CSD CRC mismatch“).</li>
            </ul>
        </li>
        <li><b>HTTP endpoint:</b>  
            <ul>
              <li><code>POST /sia-server/:id/event</code>  
                  - Vyžaduje právo <code>sia-server.write</code>.  
                  - Tělo JSON: <code>{"event":"BA","zone":"03","message":"Test"}</code>.  
                  - Server vygeneruje event do prvního výstupu.</li>
            </ul>
        </li>
      </ul>
    </p>
</script>
