<script type="text/javascript">
    // === Registrace konfiguračního node ===
    RED.nodes.registerType('sia-server-config', {
        category: 'config',
        defaults: {
            name:             { value: "" },
            port:             { value: 10000, required: true },
            password:         { value: "",      required: false },
            account:          { value: "",      required: false },
            allowedEvents:    { value: "",      required: false },
            zoneMap:          { value: "",      required: false },
            useAes:           { value: false,   required: false },
            aesKey:           { value: "",      required: false },
            reconnectInterval:{ value: 10,      required: false },
            allowedUsers:     { value: "",      required: false },
            language:         { value: "en",    required: false }
        },
        label: function() {
            return this.name || ("SIA Config " + this.port);
        }
    });

    // === Registrace hlavního node ===
    RED.nodes.registerType('sia-server', {
        category: 'sia-server',
        color:    '#A6BBCF',
        defaults: {
            name:      { value: "" },
            config:    { type: "sia-server-config", required: true },
            debugMode: { value: true, required: false },
            rawOutput: { value: true, required: false }
        },
        inputs:  1,
        outputs: 2,
        icon:    "network.png",
        label: function() {
            return this.name || "SIA Server";
        }
    });
</script>

<!-- ============================================ -->
<!-- Konfigurační node – editovací formulář       -->
<!-- ============================================ -->
<script type="text/x-red" data-template-name="sia-server-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Název konfigurace</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="icon-globe"></i> Port (TCP)</label>
        <input type="number" id="node-config-input-port" placeholder="10002">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="icon-lock"></i> Heslo/PIN (volitelné)</label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label for="node-config-input-account"><i class="icon-user"></i> Číslo účtu (volitelné)</label>
        <input type="text" id="node-config-input-account">
    </div>
    <div class="form-row">
        <label for="node-config-input-allowedEvents"><i class="icon-filter"></i> Povolené události (CSV klíče)</label>
        <input type="text" id="node-config-input-allowedEvents" placeholder="BA,BF,GC,GP">
    </div>
    <div class="form-row">
        <label for="node-config-input-zoneMap"><i class="icon-map"></i> Mapování zón (JSON)</label>
        <textarea id="node-config-input-zoneMap" style="width: 100%;" rows="3" placeholder='{"01":"Vchod","02":"Garáž"}'></textarea>
    </div>
    <div class="form-row">
        <label for="node-config-input-useAes"><i class="icon-lock-open"></i> Použít AES dešifrování</label>
        <input type="checkbox" id="node-config-input-useAes">
    </div>
    <div class="form-row">
        <label for="node-config-input-aesKey"><i class="icon-key"></i> AES klíč (hex 32 znaků)</label>
        <input type="text" id="node-config-input-aesKey" placeholder="0123456789ABCDEF0123456789ABCDEF">
    </div>
    <div class="form-row">
        <label for="node-config-input-reconnectInterval"><i class="icon-refresh"></i> Interval obnovení (s)</label>
        <input type="number" id="node-config-input-reconnectInterval" placeholder="10">
    </div>
    <div class="form-row">
        <label for="node-config-input-allowedUsers"><i class="icon-shield"></i> Povolení uživatelé (CSV)</label>
        <input type="text" id="node-config-input-allowedUsers" placeholder="0001,0002">
    </div>
    <div class="form-row">
        <label for="node-config-input-language"><i class="icon-globe"></i> Jazyk</label>
        <select id="node-config-input-language">
            <option value="en">English</option>
            <option value="cs">Čeština</option>
        </select>
    </div>
</script>

<!-- ============================================ -->
<!-- Hlavní node – editovací formulář             -->
<!-- ============================================ -->
<script type="text/x-red" data-template-name="sia-server">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Název uzlu</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="icon-cog"></i> Nastavení serveru</label>
        <input type="text" id="node-input-config">
    </div>
    <div class="form-row">
        <label for="node-input-debugMode"><i class="icon-bug"></i> Aktivovat DEBUG režim</label>
        <input type="checkbox" id="node-input-debugMode">
    </div>
    <div class="form-row">
        <label for="node-input-rawOutput"><i class="icon-eye"></i> Přeposílat RAW zprávy</label>
        <input type="checkbox" id="node-input-rawOutput">
    </div>
</script>

<!-- ============================================ -->
<!-- Nápověda pro konfigurační node               -->
<!-- ============================================ -->
<script type="text/x-red" data-help-name="sia-server-config">
    <p>
        <b>SIA Server Config</b> – sdílená konfigurace, která určuje:
        <ul>
            <li><b>Port</b>: TCP port, na kterém naslouchá ústředna (výchozí 10002)</li>
            <li><b>Heslo/PIN</b>: Volitelné ověření přístupu (pokud ústředna vyžaduje)</li>
            <li><b>Číslo účtu</b>: Identifikace ústředny (např. "123456")</li>
            <li><b>Povolené události</b>: CSV klíče eventů (např. "BA,BF,GC"), pokud se mají ignorovat ostatní</li>
            <li><b>Mapování zón</b>: JSON objekt pro pojmenování zón (např. {"01":"Vchod","02":"Garáž"})</li>
            <li><b>Použít AES</b>: Zaškrtněte, pokud je ústředna nakonfigurována na AES šifrování</li>
            <li><b>AES klíč</b>: Hexadecimální klíč 16 bajtů (32 znaků), pokud je AES aktivní</li>
            <li><b>Interval obnovení</b>: Počet sekund, po kterých se node pokusí znovu naslouchat, pokud se server uzavře</li>
            <li><b>Povolení uživatelé</b>: CSV uživatelských kódů, kteří smí posílat ARM/DISARM</li>
            <li><b>Jazyk</b>: "en" pro angličtinu (výchozí), "cs" pro češtinu (překlady)</li>
        </ul>
    </p>
</script>

<!-- ============================================ -->
<!-- Nápověda pro hlavní node                     -->
<!-- ============================================ -->
<script type="text/x-red" data-help-name="sia-server">
    <p>
        <b>SIA Server</b> – uzel naslouchá na portu zvoleném v konfiguraci. Vytváří TCP server a zpracovává:
        <ul>
            <li><b>SIA-DCS (DC-09)</b> – běžné bezpečnostní eventy</li>
            <li><b>ADM-CID (SIA-DC-05)</b> – Contact-ID s CRC-16 ověřením</li>
            <li><b>Polling rámce "F#"</b> – keep-alive, neodesílá ACK</li>
            <li><b>AES šifrování</b> – dešifruje rámce, pokud je aktivní</li>
            <li><b>Filtrace eventů</b> – pouze povolené klíče uskuteční akci</li>
            <li><b>Mapování zón</b> – čísla zón lze přeložit na texty</li>
            <li><b>Logování do souboru</b> – každá událost se ukládá do si­a-events.log</li>
            <li><b>Role-based příkazy</b> – povolení ARM/DISARM jen pro vybrané uživatele</li>
            <li><b>Status v UI</b> – zobrazuje stav připojení a chyby přímo v editoru</li>
            <li><b>HTTP endpoint</b> – možnost externě posílat eventy přes REST</li>
            <li><b>Lokalizace</b> – angličtina / čeština</li>
        </ul>
    </p>
</script>
