<script type="text/javascript">
    // === Registrace konfiguračního node ===
    RED.nodes.registerType('sia-server-config', {
        category: 'config',
        defaults: {
            name:              { value: "" },
            port:              { value: 10000, required: true },
            password:          { value: "",      required: false },
            account:           { value: "000997",      required: false },
            allowedEvents:     { value: "",      required: false },
            zoneMap:           { value: "",      required: false },
            useAes:            { value: false,   required: false },
            aesKey:            { value: "",      required: false },
            reconnectInterval: { value: 10,      required: false },
            allowedUsers:      { value: "",      required: false },
            language:          { value: "en",    required: false },
            autoRespondPolling:{ value: false,   required: false },
            pollResponseTemplate: { value: "P#${zone}", required: false }
        },
        label: function() {
            return this.name || ("SIA Config " + this.port);
        }
    });

    // === Registrace hlavního node ===
    RED.nodes.registerType('sia-server', {
        category: 'sia-server',
        color:    '#A6BBCF',
        defaults: {
            name:      { value: "" },
            config:    { type: "sia-server-config", required: true },
            debugMode: { value: false, required: false },
            rawOutput: { value: false, required: false }
        },
        inputs:  1,
        outputs: 2,
        icon:    "network.png",
        label: function() {
            return this.name || "SIA Server";
        }
    });
</script>

<!-- ============================================ -->
<!-- Konfigurační node – editovací formulář       -->
<!-- ============================================ -->
<script type="text/x-red" data-template-name="sia-server-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Název konfigurace</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="icon-globe"></i> Port (TCP)</label>
        <input type="number" id="node-config-input-port" placeholder="10002">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="icon-lock"></i> Heslo/PIN (volitelné)</label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label for="node-config-input-account"><i class="icon-user"></i> Číslo účtu (volitelné)</label>
        <input type="text" id="node-config-input-account">
    </div>
    <div class="form-row">
        <label for="node-config-input-allowedEvents"><i class="icon-filter"></i> Povolené události (CSV)</label>
        <input type="text" id="node-config-input-allowedEvents" placeholder="BA,BF,GC,GP">
    </div>
    <div class="form-row">
        <label for="node-config-input-zoneMap"><i class="icon-map"></i> Mapování zón (JSON)</label>
        <textarea id="node-config-input-zoneMap" style="width: 100%;" rows="3" placeholder='{"01":"Vchod","02":"Garáž"}'></textarea>
    </div>
    <div class="form-row">
        <label for="node-config-input-useAes"><i class="icon-lock-open"></i> Použít AES dešifrování</label>
        <input type="checkbox" id="node-config-input-useAes">
    </div>
    <div class="form-row">
        <label for="node-config-input-aesKey"><i class="icon-key"></i> AES klíč (hex 32 znaků)</label>
        <input type="text" id="node-config-input-aesKey" placeholder="0123456789ABCDEF0123456789ABCDEF">
    </div>
    <div class="form-row">
        <label for="node-config-input-reconnectInterval"><i class="icon-refresh"></i> Interval obnovení (s)</label>
        <input type="number" id="node-config-input-reconnectInterval" placeholder="10">
    </div>
    <div class="form-row">
        <label for="node-config-input-allowedUsers"><i class="icon-shield"></i> Povolení uživatelé (CSV)</label>
        <input type="text" id="node-config-input-allowedUsers" placeholder="0001,0002">
    </div>
    <div class="form-row">
        <label for="node-config-input-language"><i class="icon-globe"></i> Jazyk</label>
        <select id="node-config-input-language">
            <option value="en">English</option>
            <option value="cs">Čeština</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-config-input-autoRespondPolling"><i class="icon-repeat"></i> Automatická odpověď na polling</label>
        <input type="checkbox" id="node-config-input-autoRespondPolling">
    </div>
    <div class="form-row">
        <label for="node-config-input-pollResponseTemplate"><i class="icon-pencil"></i> Šablona odpovědi (např. P#${zone})</label>
        <input type="text" id="node-config-input-pollResponseTemplate" placeholder="P#${zone}">
    </div>
</script>

<!-- ============================================ -->
<!-- Hlavní node – editovací formulář             -->
<!-- ============================================ -->
<script type="text/x-red" data-template-name="sia-server">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Název uzlu</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="icon-cog"></i> Nastavení serveru</label>
        <input type="text" id="node-input-config">
    </div>
    <div class="form-row">
        <label for="node-input-debugMode"><i class="icon-bug"></i> Aktivovat DEBUG režim</label>
        <input type="checkbox" id="node-input-debugMode">
    </div>
    <div class="form-row">
        <label for="node-input-rawOutput"><i class="icon-eye"></i> Přeposílat RAW zprávy</label>
        <input type="checkbox" id="node-input-rawOutput">
    </div>
</script>

<!-- ============================================ -->
<!-- Nápověda pro konfigurační node               -->
<!-- ============================================ -->
<script type="text/x-red" data-help-name="sia-server-config">
    <p>
        <b>SIA Server Config</b> – sdílené nastavení:
        <ul>
            <li><b>Port:</b> TCP port, na kterém naslouchá ústředna (výchozí 10002).</li>
            <li><b>Heslo/PIN:</b> Volitelné, pokud ústředna vyžaduje ověření.</li>
            <li><b>Číslo účtu:</b> Identifikace ústředny (např. „000997“).</li>
            <li><b>Povolené události:</b> CSV (např. „BA,BF,GC“) – ostatní se ignorují.</li>
            <li><b>Mapování zón:</b> JSON pro přeložení čísel zón (např. {"01":"Vchod"}).</li>
            <li><b>Použít AES:</b> Zaškrtněte, pokud ústředna posílá šifrované zprávy.</li>
            <li><b>AES klíč:</b> Hexadecimální řetězec 16 bajtů (32 znaků).</li>
            <li><b>Interval obnovení:</b> Počet s, po kterých se zkusí znovu naslouchat po chybě.</li>
            <li><b>Povolení uživatelé:</b> CSV kódů (např. „0001,0002“) – ARM/DISARM jen pro ně.</li>
            <li><b>Jazyk:</b> Lokalizace „en“/„cs“.</li>
            <li><b>Automatická odpověď na polling:</b> Pokud zaškrtnuto, při přijmu „F#…“ odpoví podle šablony.</li>
            <li><b>Šablona odpovědi:</b> Např. <code>P#${zone}</code> – `${zone}` se nahradí skutečnou hodnotou z pollu.</li>
        </ul>
    </p>
</script>

<!-- ============================================ -->
<!-- Nápověda pro hlavní node                     -->
<!-- ============================================ -->
<script type="text/x-red" data-help-name="sia-server">
    <p>
        <b>SIA Server</b> – uzel naslouchá na vybraném portu a zpracovává:
        <ul>
            <li><b>SIA-DCS (DC-09)</b> – burzy安全 eventy.</li>
            <li><b>ADM-CID (SIA-DC-05)</b> – Contact-ID s ověřením CRC-16.</li>
            <li><b>Polling „F#…“</b> – keep-alive; odpovídá šablonou (např. <code>P#${zone}</code>).</li>
            <li><b>AES-128-CBC</b> – dešifruje CASPO rámce.</li>
            <li><b>Whitelist eventů</b> – jen povolené eventy.</li>
            <li><b>Mapování zón</b> – číslům se nastavují jména.</li>
            <li><b>Logování</b> – každá platná událost se ukládá do <code>/home/nodered/sia-events.log</code>.</li>
            <li><b>Role-based ARM/DISARM</b> – jen uživatelé z CSV.</li>
            <li><b>Retry / Reconnect</b> – po chybě se server znovu spustí.</li>
            <li><b>Status v UI</b> – ukazuje připojení/chyby.</li>
            <li><b>HTTP endpoint</b> – externí POST /sia-server/:id/event pro injektování eventů.</li>
            <li><b>Lokalizace</b> – angličtina/čeština (v textu).</li>
        </ul>
    </p>
</script>
